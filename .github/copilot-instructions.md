# AI Coding Guide for dejavuplus-bots

- **Architecture**: Two transports share one business core. Telegram runs via [app.py](app.py); WhatsApp webhook runs via FastAPI/uvicorn in [whatsapp_app.py](whatsapp_app.py). Both normalize requests into the platform-agnostic bridge flows in [bot_core/bridge.py](bot_core/bridge.py) and persist state in the JSON store managed by [bot_core/storage.py](bot_core/storage.py).
- **Configuration**: All secrets come from .env and are read through [bot_core/config.py](bot_core/config.py). Key variables: TELEGRAM_BOT_TOKEN, API_URL/API_TOKEN, BADVIN_EMAIL/PASSWORD, APICAR_API_KEY, ULTRAMSG_INSTANCE_ID/TOKEN/BASE_URL, REPORT_DEFAULT_LANG, DB_PATH, DB_BACKUP_RETENTION. Use `reload_env()` (bridge/auth helpers) instead of manual re-parsing when hot-reloading.
- **Data store**: `db.json` is the single source of truth. Writes go through `save_db()` which snapshots to [backups/](backups/) respecting DB_BACKUP_RETENTION. Add new user fields via `_default_user()` and `ensure_user()` to auto-backfill existing rows. Never stash secrets inside `settings`—`_sanitize_settings` strips them on save.
- **Bridge contracts**: Use `UserContext`, `IncomingMessage`, and `BridgeResponse` from [bot_core/bridge.py](bot_core/bridge.py) when adding flows. Menu items are registered in `MENU_REGISTRY`; localization comes from `t(key, lang, ...)` with fallbacks baked into the translation map. Keep admin-only items flagged with `requires_admin`/`requires_super`.
- **Credit and limits**: `reserve_credit`/`refund_credit`/`commit_credit` in [bot_core/storage.py](bot_core/storage.py) and mirrored helpers in [whatsapp_app.py](whatsapp_app.py) guard pending/used counters; `bump_usage` resets daily/monthly counters on access. Respect `_current_balance`/`_remaining_monthly_reports` in [app.py](app.py) before allowing VIN work.
- **VIN flow**: Normalize with `normalize_vin`/`VIN_RE` from [bot_core/utils/vin.py](bot_core/utils/vin.py). `generate_vin_report` in [bot_core/services/reports.py](bot_core/services/reports.py) caches upstream responses, prefers non-PDF for non-English, and renders PDFs via Playwright or WeasyPrint. Wrap Arabic/Kurdish output with `inject_rtl`; translation timeouts are strict—errors should surface as user-facing bridge messages, not silent passes.
- **Translation**: [bot_core/services/translation.py](bot_core/services/translation.py) races Azure, Google, LibreTranslate, and custom API; Kurdish is forced to Sorani script. Cache TTL is one hour; keep provider timeouts short (TRANSLATE_TOTAL_TIMEOUT/PROVIDER_TIMEOUT). Use `translate_batch`/`translate_html`; avoid new blocking network calls elsewhere.
- **Images**: [bot_core/services/images.py](bot_core/services/images.py) fetches photos from Badvin and ApiCar with in-memory TTL caches, HD prioritization, and 360-spin filtering. For accident photos, it picks the oldest record first, then history, then Badvin fallback. Respect semaphores `_BADVIN_SEM` to avoid hammering credentials.
- **Notifications**: [bot_core/services/notifications.py](bot_core/services/notifications.py) sends auto reminders (expiry, inactivity, low balance) and routes to WhatsApp via UltraMsg when the target looks like a phone; otherwise Telegram. Quiet hours and smart-notify rules live in `SMART_NOTIFY_RULES`. Prefer these helpers over ad-hoc bot sends.
- **WhatsApp transport**: [whatsapp_app.py](whatsapp_app.py) normalizes UltraMsg webhooks (`_extract_entries`) into bridge messages, maps numeric menu replies to cached `LAST_MENU_ITEMS`, and mirrors credit handling with `_reserve_report_slot`/`_refund_report_slot`/`_commit_report_success`. Use `_clean_html_for_whatsapp` before sending text/media.
- **Telegram transport**: [app.py](app.py) builds reply/inline keyboards per language, keeps admin panels Arabic-only, and pipes media via `_build_telegram_media_fetcher`. Super admin IDs come from .env plus DB; use `_build_bridge_user_context` to sync language/report_lang into DB before handling.
- **PDF rendering**: [bot_core/services/pdf.py](bot_core/services/pdf.py) maintains a shared Chromium instance and page pool; `_PDF_RENDER_SEM` caps concurrency. Enable WeasyPrint as a fallback; keep HTML free of scripts before `set_content`.
- **Badvin scraper**: [badvin.py](badvin.py) is a synchronous helper to log in, select the oldest sale record with photos, and filter non-car assets. It is wrapped asynchronously in `get_badvin_images` for the main bot.
- **Testing**: `python -m pytest -q` runs the suite; [tests/test_all.py](tests/test_all.py) currently covers RTL and translation expectations. Add new tests under [tests/](tests/) and ensure they import via the root `conftest` path hooks.
- **Running**: Typical local flow: `python -m venv .venv && .venv\Scripts\activate && pip install -r requirements.txt`; optional `playwright install chromium` for richer PDFs. Start Telegram with `python app.py`; start WhatsApp webhook with `python whatsapp_app.py` (exposes `/whatsapp/webhook`, defaults to WHATSAPP_HOST/PORT). `start.ps1`/`start.bat` run both.
- **Error handling**: Fail closed on missing env (empty tokens ⇒ skip external calls). `BridgeResponse` can carry `actions.temp_files` for cleanup—callers must delete temp files after sending.
- **Performance/caching**: Shared aiohttp/httpx sessions live in reports/translation/images modules; call `close_http_session` variants on shutdown to avoid warnings. Respect semaphores `_CARFAX_SEM`, `_PDF_RENDER_SEM`, and image locks when adding concurrency.
- **Style/conventions**: Keep user-facing strings translated via bridge `t` keys; avoid hardcoding Arabic/English text. Maintain RTL safety for Arabic/Kurdish HTML. Prefer async helpers (httpx/aiohttp) over new sync requests in transports.
- **Extending menus**: Add new menu items in `MENU_REGISTRY` with row/col ordering and localization keys; update translation map nearby. Ensure admin/super guard flags align with feature sensitivity.
- **Data migrations**: When changing DB shape, use `ensure_user`/`ensure_settings` to backfill. Do not mutate `settings` with secrets; they are sanitized on save.
- **CI/observability gaps**: No linter/formatter configured; keep changes small and add targeted tests. Logging is verbose for Telegram (`logging.DEBUG` on telegram.ext); keep noise manageable when adding handlers.
